---
title: "Variance Partition"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First initialize biocManager and Seurat, and walk into your directory. If you have not yet installed Seurat and ggplot2, you will need to un-hash out the biocManager commands below. 

This is a line from RStudio

```{r}
#Basic R commands: 
list.files(dir)
getwd()
setwd(dir)
head(x)
tail(x)
dim(x)
#Command + Return runs 1 line of code
#Command + option + i adds in a chunk

```

```{r}
#install.packages("BiocManager")

#BiocManager::install("Seurat")
#BiocManager::install("ggplot2")
#BiocManager::install("sctransform")

library(Seurat)
library(ggplot2)
library(sctransform)
library(dplyr)
library(ape)
library(variancePartition)
library(cowplot)
library(Matrix)

#find out where you are
getwd()
dir= "/Users/whippoorwill/Desktop/NickData"
 #set this to whatever you like, above the level of your data folder
#setwd(dir)
```


Variance Partition: Find genes that are correlated with specific features (i.e. sex, age, etc). Run on a subset of genes unless you want to run this overnight. 

 Fit model and extract results
1) fit linear mixed model on gene expression
If categorical variables are specified,a linear mixed model is used
If all variables are modeled as fixed effects, a linear model is used
each entry in results is a regression model fit on a single gene

2) extract variance fractions from each model fit for each gene, returns fraction of variation attributable to each variable
Interpretation: the variance explained by each variable after correcting for all other variables

Note that geneExpr can either be a matrix, or an ExpressionSet

```{r}
#takes a really long time if you load all genes
# geneExpr: matrix of gene expression values
# info: information/metadata about each sample

# Individual and Tissue are both categorical,so model them as random effects
# Note the syntax used to specify random effects

geneCounts = GetAssayData(sobject,slot = "counts")
geneExpr = GetAssayData(sobject,slot = "data")
var.genes = VariableFeatures(sobject)
all.genes<-rownames(sobject)

geneExpr = as.matrix(geneExpr[rownames(geneExpr)%in% var.genes,])
geneExpr = geneExpr[rowSums(geneExpr)>0,]
geneCounts = as.matrix(geneCounts[rownames(geneCounts)%in% var.genes,])
geneCounts = geneCounts[rowSums(geneCounts)>0,]

info = sobject@meta.data
form <- ~ percent.mito + (1|sex) + (1|age) + (1|condition)

varPart <- fitExtractVarPartModel(geneExpr, form, info )
# sort variables (i.e. columns) by median fraction of variance explained
vp <- sortCols(varPart )

#order on sex
vs = varPart[order(varPart$sex,decreasing = T),]
vm = varPart[order(varPart$percent.mito,decreasing = T),]

# Bar plot of variance fractions for the first 10 genes
plotPercentBars( vm[1:10,] )
plotPercentBars( vs[1:20,] )

# violin plot of contribution of each variable to total variance
plotVarPart( vm )
plotVarPart( vs )

setEPS()
postscript("~/Desktop/sobjectvariancesex.eps")
plotPercentBars( vs[1:20,] )
dev.off()
```

Skip this for zebrafish for now
```{r}
sexgenes = c("Xist","Tsix","Uty","Ddx3y","Eif2s3y")
mitogenes = c("mt-Nd1")
remove.genes = c(sexgenes,mitogenes)
```

Skip this for zebrafish
```{r}
scalegenes = scalegenes[!scalegenes %in% remove.genes]
sobject<-ScaleData(sobject,features = scalegenes, vars.to.regress = c("nCount_RNA"))
```


