---
title: "Seurat_Code_PostQC_2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


```{r}
#install.packages("BiocManager")

#BiocManager::install("Seurat")
#BiocManager::install("ggplot2")
#BiocManager::install("sctransform")

library(Seurat)
library(ggplot2)
library(sctransform)
library(dplyr)
library(ape)
library(variancePartition)
library(cowplot)
library(Matrix)

#find out where you are
getwd()
dir= "/Users/whippoorwill/Desktop/Sequencing/Nick/2_2020"
 #set this to whatever you like, above the level of your data folder
#setwd(dir)
```

```{r}
load(file.path(dir,"NickData/Nick2020_unfiltered.RData"))
```

Set limits based on the graphs from the QC page
```{r}
mlo = -0.1
mhi = 10
clo = 1200
chi = 15000
flo = 500
fhi = 3000
rlo = 0
rhi = 70
```

Subset the data. Printing tables lets you see the progression as you tighten your QC cutoffs. 
```{r}
print("initial")
table(sobject$sample_description) #print out initial cell counts
sobject = subset(sobject, subset = percent.mito>mlo & percent.mito < mhi) #subset mitochondria
print("mito")
table(sobject$sample_description) #new cell counts
sobject = subset(sobject, subset = nCount_RNA>clo & nCount_RNA < chi)
print("ncount")
table(sobject$sample_description)
sobject = subset(sobject, subset = nFeature_RNA>flo & nFeature_RNA < chi)
print("nfeature")
table(sobject$sample_description)
```

```{r}
save(sobject, file = file.path(dir,"sobject_filtered_umap.RData"))
```

Find variable features, normalize, scale, run PCA, clustering, umap

Include any genes that may not vary a lot but are important for downstream applications.
```{r}
add.genes = c('ptprc','lgmn','hexb','apoeb','mpeg1.1')
regress = c("nFeature_RNA")
```

```{r}
sobject<-FindVariableFeatures(sobject, selection.method = "vst", nfeatures = 25000)
all.genes<-rownames(sobject)
var.genes = VariableFeatures(sobject)

add.genes = add.genes[!add.genes %in% var.genes]
any(add.genes %in% var.genes)
scalegenes = c(var.genes,add.genes)

sobject<-ScaleData(sobject,features = scalegenes, vars.to.regress = regress)
sobject <- RunPCA(sobject,features = scalegenes,npcs = 50, verbose = FALSE)

sobject<-RunUMAP(sobject,reduction = "pca",dims = 1:30, verbose = F)
sobject<-FindNeighbors(sobject,dims=1:30,verbose=F)

res = 0.3 #set this to anything
sobject<-FindClusters(sobject,verbose=F,resolution = res) 
save(sobject,file = file.path(dir,"filtered_afterQC_umap.RData"))
```

Plot important objects; check parameters before moving forward, evaluate QC
```{r}
dims = c("seurat_clusters","sample_description","age")
QC = c("nCount_RNA","nFeature_RNA","percent.mito","percent.ribo")

for (dim in dims){
  DimPlot(sobject,group.by = dim, label = T)
}

FeaturePlot(sobject,add.genes)
FeaturePlot(sobject,QC)

VlnPlot(sobject,add.genes,sort = "increasing",pt.size = 0.01)
```

Build a clustering tree
```{r}
Idents(sobject) = "seurat_clusters"
sobject= BuildClusterTree(sobject,dims = 1:30)
tree = sobject@tools$BuildClusterTree
plot.phylo(tree, use.edge.length = T, direction = "rightwards")
```

Save the tree
```{r}
setEPS()
postscript(file.path(dir,"tree_iteration1.eps"))
plot.phylo(tree, use.edge.length = T, direction = "rightwards")
dev.off()
```

Select mpeg+ clusters
```{r}
#using mpeg_all
#mpeg = c(0,1,3,4,5,7,8,10,14)
#cd45 = c(2,6,9,11,12,13,15)

#using mpeg_all_2
mpeg = c(4,3,0,5,8,2,7,6,15)
cd45 = c(11,16,1,14,10,12,13,9)
type = c(0:16)
type
type[mpeg+1] = "mpeg"
type[cd45+1] = "cd45"
cluster = as.factor(sobject$seurat_clusters)
levels(cluster) = type
sobject$type = cluster
table(sobject$type,sobject$seurat_clusters)

```
Subset the data to include only mpeg+ clusters: 
```{r}
sobject = subset(sobject,subset = type == "mpeg")
table(sobject$type,sobject$seurat_clusters)
save(sobject,file = file.path(dir,"Graphs_Analysis_August2020 mpeg only/Data/mpegonly_all_3.RData"))
```



Normalize the data - counts per 10k - set by the "scale.factor". Raw data has the original data; the data slot has the filtered data (from above); the normalization will work on the raw data but only pulls the cells that are included in your filtered "data" and store the normalization as data (NOT the scale data slot) - so it isn't working on the filtered data, it's working on the raw data. The only filter they take into account is for cells - you can't filter out genes before normalization. 


```{r}
sobject <- NormalizeData(sobject,normalization.method = "LogNormalize", scale.factor = 10000)
#select some housekeeping genes
genes = c("mpeg1.1",'hexb','ptprc','cd74a','lgmn') 
VlnPlot(sobject,genes,group.by = "sample_description")
GetAssayData(sobject)[1:10, 1:15]
table(sobject$sample_description)
```


Filtering out genes in Seurat - use AFTER normalization. Works on data object (i.e. normalized, filtered data). 
Option A: standard

```{r}
sobject<-FindVariableFeatures(sobject, selection.method = "vst", nfeatures = 6000)
top10 <- head(VariableFeatures(sobject),10)
plot1 <- VariableFeaturePlot(sobject)
plot2 <- LabelPoints(plot=plot1, points = top10, repel = T, xnudge = 0, ynudge = 0)
plot2
```

Scale the data
```{r}
all.genes<-rownames(sobject)
var.genes = VariableFeatures(sobject)
add.genes = c('fcrls', 'olfml3', 'lgmn', 'cx3cr1','hexb','apoeb','mpeg1.1')
add.genes = add.genes[!add.genes %in% var.genes]
any(add.genes %in% var.genes)
scalegenes = c(var.genes,add.genes)

sobject<-ScaleData(sobject,features = scalegenes, vars.to.regress = c("nFeature_RNA"))
```



Dimensionality reduction. Note that UMAP can be run directly on most variable features as well, but this will take forever unless you severely restrict #genes. 
```{r}
sobject <- RunPCA(sobject,features = scalegenes,npcs = 50, verbose = FALSE)
set.seed(1)
#figure out how many PCs to use - can default to 30
ElbowPlot(sobject,ndims = 50, reduction = "pca")
print(sobject[["pca"]], dims = 1:20, nfeatures = 5)
#look for heat shock proteins or Malat1
FeaturePlot(sobject,"percent.mito",reduction = "pca",dims = 1:2 )
```


```{r}
set.seed(1)
sobject<-RunUMAP(sobject,reduction = "pca",dims = 1:30, verbose = F)
sobject<-FindNeighbors(sobject,dims=1:30,verbose=F)
set.seed(1)
res = seq(0.5,3,by = 0.5) #set this to anything
sobject<-FindClusters(sobject,verbose=F,resolution = 0.3) 
save(sobject,file = file.path(dir,"Graphs_Analysis_August2020 mpeg only/Data/mpegonly_all_3.RData"))
```

Function to print multiple graphs: 

```{r}
PrintSeuratGraph = function(namecard = "a",sobject,graphtype = "feature",feature = NULL,group = NULL,split=NULL,cellnames=NULL){
  if (!is.null(cellnames)){
    Idents(sobject) = cellnames[1]
    cells = colnames(sobject)[Idents(sobject) %in% cellnames[2:length(cellnames)]]} 
  else {cells = cellnames}
  if (graphtype == "feature"){
    graph = FeaturePlot(sobject,features = feature,split.by = split, cells = cells,cols = c("lightgrey","lightblue","yellow","orange","darkorange","red"))
  }
  if (graphtype == "violin"){
    graph = VlnPlot(sobject,features = feature, pt.size = 0.1, idents = cellnames[2:length(cellnames)],group.by = group, split.by = split)
  }
  if (graphtype == "dim"){
    graph = DimPlot(sobject,cells = cells, group.by = group, split.by = split)
    
  }
  name = paste0(feature,"_",graphtype,namecard,".eps")
  graph
  setEPS()
  postscript(file.path("~/Desktop",name))
  print(graph)
  dev.off()
}

```

```{r}
DimPlot(sobject,label=T,reduction = "umap")
genes = c("marco","mpeg1.1","apoeb","p2ry12","ptprc","hexb","irf8","spi1b","spi1a","csf1ra","csf1rb","slc7a7","c1qa","c1qb","c1qc")

features = c("percent.mito","percent.ribo","nCount_RNA","nFeature_RNA")
genesHB = c("ccl19a.1","wipf1a","b2m","plp1b","krt18b","cxcr4b","cd74b","cd74a","gpatch8","mhc2dab","ms4a17a.6","cdc42l","dhrs9","bzw1b","lygl1","hmga1a","top1l","plekho2")

genesOT = c("bzw2","slc40a1","g0s2","ctsla","eepd1","slc43a2b","apoeb","pitpnaa","rnaset2","mt2","ctsz","cndp2","dpp7","abca1a","pdgfd","ctsd","pepd","mafbb","ppdpfb","slc7a7","glud1b","porb","galk1","bri3","glula","abhd12","ubb","rgl1","mpp1","hmgb3a","abca1b","ctsba","ctsc","vat1")

length(genesOT)

genes = genes[genes %in% scalegenes]
FeaturePlot(sobject,genes[1:5],reduction = "umap")
FeaturePlot(sobject,genes[6:9], reduction = "umap")
FeaturePlot(sobject,features = "percent.mito")
FeaturePlot(sobject,features = "nCount_RNA")
FeaturePlot(sobject,features = "nFeature_RNA")
FeaturePlot(sobject,features = "percent.ribo")

for(feature in c(genes,features)){
  PrintSeuratGraph(namecard = "all_mpeg",sobject=sobject,graphtype = "feature",feature = feature)
}

groups = c("age","sample_description","seurat_clusters")

for(group in groups){
  PrintSeuratGraph(namecard = "all_mpeg",sobject=sobject,graphtype = "dim",group = group, feature = group)
}

for(feature in genes){
  PrintSeuratGraph(namecard = "all_mpeg",sobject=sobject,graphtype = "violin",feature = feature,group = "seurat_clusters")
}
```



```{r}
DimPlot(sobject,reduction = "umap",group.by = "sample_description")
DimPlot(sobject,reduction = "umap",group.by = "sample_description",split.by = "age")
DimPlot(sobject,reduction = "umap",group.by = "seurat_clusters",split.by = "sample_description",label = F)

setEPS()
postscript("~/Desktop/juv_adult_split.eps")
DimPlot(sobject,reduction = "umap",group.by = "sample_description",split.by = "age")
dev.off()

setEPS()
postscript("~/Desktop/juv_adult_umap.eps")
DimPlot(sobject,reduction = "umap",group.by = "sample_description")
dev.off()

setEPS()
postscript("~/Desktop/splitall_umap.eps")
DimPlot(sobject,reduction = "umap",group.by = "seurat_clusters",split.by = "sample_description",label = F)
dev.off()
```


```{r}
Idents(sobject) = "seurat_clusters"
sobject= BuildClusterTree(sobject,dims = 1:30)
tree = sobject@tools$BuildClusterTree
setEPS()
postscript("~/Desktop/tree_allmpeg.eps")
plot.phylo(tree, use.edge.length = T, direction = "rightwards")
dev.off()
```

Heatmap for sobject
```{r}
Idents(sobject) = "seurat_clusters"
markers_all <- FindAllMarkers(
    object = sobject,
    features = rownames(GetAssayData(sobject,slot = "scale.data")),
    test.use = "MAST",
    only.pos = FALSE, 
    min.pct = 0.25, #gene must be present in 25% of the cells in the cluster
    logfc.threshold = 0.20
)

dim(markers_all)
head(markers_all)
write.csv(markers_all,file = "~/Desktop/all_markers_mpeg.csv")

markers_all = markers_all[markers_all$avg_logFC>0.2,]
pcut = 10^-50
markers_all = markers_all[markers_all$p_val_adj<pcut,]
markers_all_single <- markers_all[markers_all$gene %in% names(table(markers_all$gene))[table(markers_all$gene) == 1],] #markers that define a single cluster

topgenes <- markers_all_single %>% group_by(cluster) %>% top_n(10, avg_logFC)

setEPS()
postscript("~/Desktop/heatmap_allmpeg_pval50.eps")
DoHeatmap(
    object = sobject, 
    features = topgenes$gene,
    group.by = 'seurat_clusters',
    size = 5,
    label = T,
    draw.lines = T
)

dev.off()
```
```{r}
load("/Users/whippoorwill/Desktop/Sequencing/Nick/2_2020/Graphs_Analysis_August2020 mpeg only/Data/mpegonly_all_3.RData")

de = read.csv("~/Desktop/Sequencing/Nick/2_2020/Graphs_Analysis_August2020 mpeg only/all cells/spreadsheets/all_markers_mpeg.csv")

head(de)
```


```{r}

DimPlot(sobject,label = T)
DimPlot(sobject,group.by = "sample_description")

FeaturePlot(sobject,c("hexb",'p2ry12','mpeg1.1','pcna'))
VlnPlot(sobject,c('hexb','p2ry12','apoeb','ptprc','mpeg1.1'),pt.size = 0.001,sort = T)

sobject = BuildClusterTree(sobject,dims = 1:30)
PlotClusterTree(sobject)


```
```{r}
table(sobject$age,sobject$seurat_clusters)
```


```{r}
juv = c(0,2,6,9)
adult = c(1,5,7,8)
macrophage = c(4)
proliferating = 3

clusters = as.factor(sobject$seurat_clusters)
table(clusters)
x = as.character(levels(clusters))
x[juv+1] = "juvenile"
x[adult+1] = "adult"
x[macrophage+1] = "macrophage"
x[proliferating+1] = "proliferating"
levels(clusters) = x
sobject$juv_v_adult = clusters
table(sobject$juv_v_adult,sobject$seurat_clusters)
save(sobject,file = "~/Desktop/mpeg_all.RData")


```

```{r}
setEPS()
postscript("~/Desktop/all_vln_mpeg_pcna_bytype.eps")
VlnPlot(sobject,c("mpeg1.1","pcna"),group.by = "juv_v_adult")
dev.off()
```

```{r}
table(de$cluster)
de[de$cluster == '3',]
de[de$cluster == '4',]
FeaturePlot(sobject,c('pcna','mki67'))
DimPlot(sobject,group.by = "juv_v_adult")
groups = c("juv_v_adult","sample_description","seurat_clusters")

for(group in groups){
  PrintSeuratGraph(namecard = "juv_v_adult_mpeg",sobject=sobject,graphtype = "dim",group = group, feature = group)
}
```
```{r}
sobject = BuildClusterTree(sobject,dims = c(1:30))
tree = sobject@tools$BuildClusterTree
setEPS()
postscript("~/Desktop/tree_mpegall.eps")
plot.phylo(tree, use.edge.length = T, direction = "rightwards")
dev.off()
```
```{r}
Idents(sobject) = 'juv_v_adult'
markers_all = FindAllMarkers(
  object = sobject,
  features = rownames(GetAssayData(sobject,slot = "scale.data")),
  test.use = "MAST", 
  only.pos = FALSE, 
  min.pct = 0.10, 
  logfc.threshold = 0.00)


dim(markers_all)


```

```{r}
head(markers_all)
write.csv(markers_all,file = "~/Desktop/juv_v_adult_mpeg.csv")



pcut = 10^-50
markers_all = markers_all[markers_all$p_val_adj<pcut,]
markers_all = markers_all[markers_all$avg_logFC>0.2,]

markers_all_single <- markers_all[markers_all$gene %in% names(table(markers_all$gene))[table(markers_all$gene) == 1],] #markers that define a single cluster

topgenes <- markers_all_single %>% group_by(cluster) %>% top_n(10, avg_logFC)

setEPS()
postscript("~/Desktop/heatmap_juv_v_adult_mpeg_pval502.eps")
DoHeatmap(
    object = sobject, 
    features = topgenes$gene,
    group.by = 'juv_v_adult',
    size = 5,
    label = T,
    draw.lines = T
)

dev.off()

```


